#!/bin/sh

# SETTINGS
LAST_PERCENT_FILE="/tmp/bat_last_percent"
SHUTDOWN_LOCK="/tmp/bat_shutdown_lock"

case $BLOCK_BUTTON in
    3) notify-send "Battery module" "$(upower -i /org/freedesktop/UPower/devices/battery_BAT1)" ;;
    4) brightnessctl set 10%+ ;;
    5) brightnessctl set 10%- ;;
    6) setsid -f kitty -e "$EDITOR" "$0" ;;
esac

for battery in /sys/class/power_supply/BAT?*; do
    status_raw=$(cat "$battery/status")
    capacity=$(cat "$battery/capacity")

    # 1. EMERGENCY SHUTDOWN (at 10%)
    if [ "$status_raw" = "Discharging" ] && [ "$capacity" -le 25 ]; then
        if [ ! -f "$SHUTDOWN_LOCK" ]; then
            touch "$SHUTDOWN_LOCK"
            (
                notify-send -u critical "CRITICAL: 20% BATTERY" "Shutting down in 30s! Plug in now to cancel."
                sleep 30
                # Re-check status after 30 seconds
                if [ "$(cat "$battery/status")" = "Discharging" ]; then
                    notify-send -u critical "System" "Powering off now..."
                    sudo shutdown -h now
                else
                    notify-send "Shutdown Aborted" "Charger detected."
                fi
                rm "$SHUTDOWN_LOCK"
            ) &
        fi
    fi

    # 2. LOW BATTERY NOTIFS (40% and below)
    if [ "$status_raw" = "Discharging" ] && [ "$capacity" -le 40 ]; then
        warn="!!"
        last_percent=$(cat "$LAST_PERCENT_FILE" 2>/dev/null || echo 0)
        if [ "$capacity" != "$last_percent" ]; then
            notify-send -u critical "Battery Low" "Capacity: ${capacity}%"
            echo "$capacity" > "$LAST_PERCENT_FILE"
        fi
    fi

    # 3. RESET ON CHARGE
    if [ "$status_raw" = "Charging" ] || [ "$status_raw" = "Full" ]; then
        [ -f "$LAST_PERCENT_FILE" ] && rm "$LAST_PERCENT_FILE"
        [ -f "$SHUTDOWN_LOCK" ] && rm "$SHUTDOWN_LOCK"
    fi

    # 4. TUNED (Optimized)
    current_profile=$(tuned-adm active | awk '{print $NF}')
    
    if [ "$status_raw" = "Discharging" ]; then
        if [ "$capacity" -le 30 ]; then
            target="powersave"
        else
            target="balanced-battery"
        fi
    else
        target="throughput-performance"
    fi

    # Icons
    if [ "$status_raw" = "Charging" ]; then
        icon="󱐋" # Bolt icon for charging
    elif [ "$status_raw" = "Full" ]; then
        icon="󰁹"
    else
        # Select icon based on 10% intervals
        if [ "$capacity" -ge 90 ]; then icon="󰁹";
        elif [ "$capacity" -ge 80 ]; then icon="󰂂";
        elif [ "$capacity" -ge 70 ]; then icon="󰂁";
        elif [ "$capacity" -ge 60 ]; then icon="󰂀";
        elif [ "$capacity" -ge 50 ]; then icon="󰁿";
        elif [ "$capacity" -ge 40 ]; then icon="󰁾";
        elif [ "$capacity" -ge 30 ]; then icon="󰁽";
        elif [ "$capacity" -ge 20 ]; then icon="󰁼";
        elif [ "$capacity" -ge 10 ]; then icon="󰁻";
        else icon="󰂃"; fi
    fi

    printf "%s %s%d%%" "$icon" "$warn" "$capacity"; unset warn
done && printf "\\n"
